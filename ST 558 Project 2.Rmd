---
title: "Project 2"
author: "Rachel Hencher"
date: "2022-09-26"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: cerulean
    highlight: pygments
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The goal for this project is to create a vignette about contacting an API using functions created to query, parse, and return well-structured data. Then, to use the functions to obtain data from the API and do some exploratory data analysis.  

# Required packages  

`tidyverse`: a collection of R packages that are designed to work together to allow us to read in, transform, and visualize data  
`httr`: allows us to use the `GET` function to access the API   
`jsonlite`: allows us to access the `fromJSON` function to convert JSON data to a data frame  
`ggplot2`: a package in the tidyverse that we will use for creating graphics
```{r, message=FALSE}
library(tidyverse)
library(httr)
library(jsonlite)
library(ggplot2)
library(gridExtra)
state = "NC"
locale = "town"
```

# Functions  
Each of the functions below will contact the chosen API and return well-formatted, parsed data in the form of data frames.  

## `general_info()`  
The following function returns general information on either the largest or smallest *n* colleges in a particular state. The user should provide input for five arguments:  
- `key` requests the user's personal key to access the API  
- `state` requests which state the user would like to retrieve info for using the 2-character abbreviation for the state  
- `size` requests whether the user would like data on large or small schools by selecting "desc" or "asc" respectively  
- `n` is the number of records returned (1-100)  
- `year` requests data from a particular year if the user desires data other than the latest available
```{r}
general_info <- function(key="D3KHf387z9W0EaDoVZNsvD6aOSHPWZmwDvKpTxpr", state="NC", size="desc", n=50, year="latest")
{
  url <- paste0("http://api.data.gov/ed/collegescorecard/v1/schools?api_key=", key, "&school.state=", state, "&per_page=", n, "&sort=student.size:", size, "&_fields=school.name,school.ownership,", year, ".student.size,", year, ".admissions.admission_rate.overall,", year, ".cost.tuition.in_state,", year, ".cost.tuition.out_of_state")

  data <- GET(url)

  parsed_data <- fromJSON(rawToChar(data$content))
  
  parsed_data$results$school.ownership <- as.factor(parsed_data$results$school.ownership)
        levels(parsed_data$results$school.ownership) <- c("Public", "Private, Nonprofit", "Proprietary")
  
  general_data <-
    parsed_data$results %>%
    as_tibble() %>%
    select("Name"=ends_with("name"), "Ownership"=ends_with("ownership"), "Size"=ends_with("size"), "Admissions_Rate"=ends_with("overall"), "In_State_Tuition"=ends_with("in_state"), "Out_of_State_Tuition"=ends_with("out_of_state"))

return(general_data)
}

general_info()
```

## `cost_info()`  
The following function returns cost info on either the most or least expensive *n* colleges in a particular state by in-state tuition. The user should provide input for five arguments:  
- `key` requests the user's personal key to access the API  
- `state` requests which state the user would like to retrieve info for using the 2-character abbreviation for the state  
- `cost` requests whether the user would like data on expensive or more affordable schools by selecting "desc" or "asc" respectively  
- `n` is the number of records returned (1-100)  
- `year` requests data from a particular year if the user desires data other than the latest available
```{r}
cost_info <- function(key="D3KHf387z9W0EaDoVZNsvD6aOSHPWZmwDvKpTxpr", state="NC", cost="desc", n=50, year="latest")
{
  url <- paste0("http://api.data.gov/ed/collegescorecard/v1/schools?api_key=", key, "&school.state=", state, "&per_page=", n, "&sort=cost.tuition.in_state:", cost, "&_fields=school.name,school.ownership,", year, ".cost.tuition.in_state,", year, ".cost.tuition.out_of_state,", year, ".cost.booksupply,", year, ".cost.roomboard.oncampus,", year, ".cost.roomboard.offcampus")

  data <- GET(url)

  parsed_data <- fromJSON(rawToChar(data$content))

  cost_data <-
    parsed_data$results %>%
    as_tibble() %>%
    select("Name"=ends_with("name"), "Ownership"=ends_with("ownership"), "In_State_Tuition"=contains("in"), "Out_of_State_Tuition"=contains("out"), "Books_Supplies"=ends_with("supply"), "Room_Board_On"=ends_with("oncampus"), "Room_Board_Off"=ends_with("offcampus"))
  
    cost_data$Ownership <- as.factor(cost_data$Ownership)
      levels(cost_data$Ownership) <- c("Public", "Private, Nonprofit", "Proprietary")

return(cost_data)
}

cost_info()
```

## `admissions_info()`  
The following function returns admissions info on *n* colleges under a particular "ownership" category. The user should provide input for five arguments:  
- `key` requests the user's personal key to access the API  
- `ownership` requests whether the user would like to retrieve admissions info for "1" (public), "2" (private, nonprofit), or "3" (proprietary) colleges  
- `rate` requests whether the user would like data on less competitive or more selective schools by selecting "desc" or "asc" respectively  
- `n` is the number of records returned (1-100)  
- `year` requests data from a particular year if the user desires data other than the latest available
```{r}
admissions_info <- function(key="D3KHf387z9W0EaDoVZNsvD6aOSHPWZmwDvKpTxpr", ownership=1, rate="asc", n=50, year="latest")
{
  url <- paste0("http://api.data.gov/ed/collegescorecard/v1/schools?api_key=", key, "&school.ownership=", ownership, "&per_page=", n, "&sort=admissions.admission_rate.overall:", rate, "&school.degrees_awarded.predominant=3&_fields=school.name,school.ownership,", year, ".admissions.admission_rate.overall,", year, ".admissions.test_requirements,", year, ".admissions.sat_scores.midpoint.critical_reading,", year, ".admissions.sat_scores.midpoint.writing,", year, ".admissions.sat_scores.midpoint.math,", year, ".admissions.act_scores.midpoint.english,", year, ".admissions.act_scores.midpoint.writing,", year, ".admissions.act_scores.midpoint.math")

  data <- GET(url)

  parsed_data <- fromJSON(rawToChar(data$content))

  admissions_data <-
    parsed_data$results %>%
    as_tibble() %>%
    select("Name"=ends_with("name"), "Ownership"=ends_with("ownership"), "Admissions_Rate"=ends_with("overall"), "Test_Requirements"=ends_with("requirements"), "SAT_Reading"=ends_with("reading"), "SAT_Writing"=ends_with("sat_scores.midpoint.writing"), "SAT_Math"=ends_with("sat_scores.midpoint.math"), "ACT_English"=ends_with("english"), "ACT_Writing"=ends_with("act_scores.midpoint.writing"), "ACT_Math"=ends_with("act_scores.midpoint.math"))
  
    admissions_data$Ownership <- as.factor(admissions_data$Ownership)
      levels(admissions_data$Ownership) <- c("Public", "Private, Nonprofit", "Proprietary")
    
    admissions_data$Test_Requirements <- as.factor(admissions_data$Test_Requirements)
      levels(admissions_data$Test_Requirements) <- c("Required", "Recommended", "Neither required nor recommended", "Do not know", "Considered but not required")
  
return(admissions_data)
}

admissions_info()
```

## `demographic_info()`  
The following function returns demographic  information of the school based on the location info on *n* colleges. The user should provide input four arguments:  
- `key` requests the user's personal key to access the API  
- `locale` requests the user to mention if they would like to see data on the location of the school.(city/suburb/town/rural)
- `rate` requests whether the user would like data on the number of students in the school by selecting "desc" or "asc" respectively  
- `n` is the number of records returned (1-100)

```{r}
demographic_info <- function(key="k42psBgICW3DEe6eS1gc7AxbTTYtOwOGN9URGVuT", state = "NC", locale="town", n=50, size = "asc")
{
  location <- ifelse(locale=="city", "11, 12, 13", 
                     ifelse(locale=="suburb", "21, 22, 23",
                            ifelse(locale=="town", "31, 32, 33",
                                   ifelse(locale=="rural", "41, 42, 43", "ERROR"))))
  url <- paste0("http://api.data.gov/ed/collegescorecard/v1/schools?api_key=", key, "&per_page=", n, "&school.state=", state, "&school.locale=", location, "&sort=student.size:", size)

  data <- GET(url)

  parsed_data <- fromJSON(rawToChar(data$content))
  
  school <- parsed_data$results$latest$school %>% 
    select(c("name", "state", "city", "ownership")) 
  
  total_enrollment <- parsed_data$results$latest$student$size
  
  school$ownership <- as.factor(school$ownership)
        levels(school$ownership) <- c("Public", "Private, Nonprofit", "Proprietary")
  
  race_ethnicity <- parsed_data$results$latest$student$demographics$race_ethnicity %>% 
    select("aian", "nhpi", "asian", "black", "white", "hispanic", "unknown")
  
  men <- parsed_data$results$latest$student$demographics$men
  
  women <- parsed_data$results$latest$student$demographics$women
  
  demographic_data <- 
    cbind(school, total_enrollment, race_ethnicity, men, women) %>%
    as_tibble()
  
  demographic_data <- demographic_data %>% 
    mutate(total_aian = round(total_enrollment*aian), 
           total_nhpi = round(total_enrollment*nhpi), 
           total_asian = round(total_enrollment*asian), 
           total_black = round(total_enrollment*black),
           total_white = round(total_enrollment*white), 
           total_hispanic = round(total_enrollment*hispanic),
           total_unknown = round(total_enrollment*unknown),
           total_men = round(total_enrollment*men),
           total_women = round(total_enrollment*women)) %>% 
    select(name, city, ownership, starts_with("total_")) %>% 
    pivot_longer(cols = !c(name, city, ownership), names_to = "ethnicity_gender", values_to = "count") 
  
return(demographic_data)
}
demographic_info()
```

## `financial_info()`  
The following function returns student financial information on either the largest or smallest *n* colleges in a particular state. The user should provide input for five arguments:  
- `key` requests the user's personal key to access the API  
- `state` requests which state the user would like to retrieve info for using the 2-character abbreviation for the state  
- `size` requests whether the user would like data on large or small schools by selecting "desc" or "asc" respectively  
- `n` is the number of records returned (1-100)  
- `year` requests data from a particular year if the user desires data other than the latest available
```{r, eval=FALSE}
financial_info <- function(key="D3KHf387z9W0EaDoVZNsvD6aOSHPWZmwDvKpTxpr", state="NC", size="desc", n=50, year="latest")
{
  url <- paste0("http://api.data.gov/ed/collegescorecard/v1/schools?api_key=", key, "&school.state=", state, "&per_page=", n, "&sort=student.size:", size, "&_fields=school.name,school.ownership,school.city,", year, ".student.size,", year, ".student.demographics.poverty_rate,", year, ".student.demographics.median_family_income,", year, ".aid.median_debt.female_students,", year, ".aid.median_debt.male_students")

  data <- GET(url)

  parsed_data <- fromJSON(rawToChar(data$content))
  
  financial_data <- 
    parsed_data$results %>%
    as_tibble() %>%
    select("Name"=ends_with("name"), "Ownership"=ends_with("ownership"), "City"=ends_with("city"), "Size"=ends_with("size"), "Poverty_rate"=ends_with("poverty_rate"), "Median_Family_Income"=ends_with("income"), "Female_Median_Debt"=ends_with("female_students"), "Male_Median_Debt"=ends_with("debt.male_students"))
  
    financial_data$Ownership <- as.factor(financial_data$Ownership)
      levels(financial_data$Ownership) <- c("Public", "Private, Nonprofit", "Proprietary")

return(financial_data)
}

financial_info()
```

## `earnings_info()`  
The following function returns earnings information on *n* colleges with either the highest or lowest median student earnings 10 years after entry. The user should provide input for four arguments:  
- `key` requests the user's personal key to access the API  
- `earnings` requests whether the user would like data on schools whose students are the highest earners or lowest earners by selecting "desc" or "asc" respectively  
- `n` is the number of records returned (1-100)  
- `year` requests data from a particular year if the user desires data other than the latest available
```{r}
earnings_info <- function(key="D3KHf387z9W0EaDoVZNsvD6aOSHPWZmwDvKpTxpr", earnings="desc", n=50, year="latest")
{
  url <- paste0("http://api.data.gov/ed/collegescorecard/v1/schools?api_key=", key, "&per_page=", n, "&sort=earnings.10_yrs_after_entry.median:", earnings, "&school.degrees_awarded.predominant=3&_fields=school.name,", year, ".cost.tuition.in_state,", year, ".cost.tuition.out_of_state,", year, ".earnings.10_yrs_after_entry.median,", year, ".earnings.10_yrs_after_entry.mean_earnings.female_students,", year, ".earnings.10_yrs_after_entry.mean_earnings.male_students")

  data <- GET(url)

  parsed_data <- fromJSON(rawToChar(data$content))

  earnings_data <-
    parsed_data$results %>%
    as_tibble() %>%
    select("Name"=ends_with("name"), "In_State_Tuition"=ends_with("in_state"), "Out_of_State_Tuition"=ends_with("out_of_state"), "Median_Earnings"=ends_with("median"), "Mean_For_Females"=ends_with("female_students"), "Mean_For_Males"=ends_with("mean_earnings.male_students"))

return(earnings_data)
}

earnings_info()
```

# Data Exploration
```{r, warning=FALSE}
general_data <- general_info(n=100)
plot1 <- ggplot(general_data, aes(x=Ownership, y=Size)) + 
  geom_boxplot() + 
  labs(title="Size by Ownership Type for State Colleges") + 
  theme_minimal()
plot1

plot2 <- ggplot(general_data, aes(x=Admissions_Rate, y=In_State_Tuition)) + 
  geom_point(aes(color=Ownership)) + 
  labs(x="Admissions Rate", y="In-State Tuition", title="In-State Tuition vs Admissions Rate for State Colleges") + 
  theme_minimal()
plot2

plot3 <- ggplot(general_data, aes(x=Admissions_Rate, y=Out_State_Tuition)) + 
  geom_point(aes(color=Ownership)) + 
  labs(x="Admissions Rate", y="Out-of-State Tuition", title="Out-of-State Tuition vs Admissions Rate for State Colleges") + 
  theme_minimal()
plot3
```

```{r, warning=FALSE, message=FALSE}
admissions_data <- admissions_info()
admissions_data2 <- admissions_data %>%
  mutate("Total_SAT"=(sumrow=SAT_Reading+SAT_Math), "Total_ACT"=(sumrow=ACT_English+ACT_Math))

plot4 <- ggplot(admissions_data2, aes(x=Admissions_Rate, y=Total_SAT)) + 
  geom_point(aes(shape=Test_Requirements, color=Test_Requirements)) + 
  geom_smooth(method=lm) + labs(x="Admissions Rate", y="Total SAT for Reading/Math", title="Total SAT Score vs Admissions Rate for US Colleges") + 
  theme_minimal()
plot4

plot5 <- ggplot(admissions_data2, aes(x=Admissions_Rate, y=Total_ACT)) + 
  geom_point(aes(shape=Test_Requirements, color=Test_Requirements)) + 
  geom_smooth(method=lm) + 
  labs(x="Admissions Rate", y="Total ACT for English/Math", title="Total ACT Score vs Admissions Rate for US Colleges") + 
  theme_minimal()
plot5

plot6 <- ggplot(admissions_data2, aes(x=Total_SAT, y=Total_ACT)) + 
  geom_point(aes(shape=Test_Requirements, color=Test_Requirements)) + 
  geom_smooth(method=lm) + 
  labs(x="Total SAT for Reading/Math", y="Total ACT for English/Math", title="Total ACT Score vs Total SAT Score for US Colleges") + 
  theme_minimal()
plot6
```

```{r, warning=FALSE, message=FALSE}
costs_data <- cost_info(n=100)

plot7 <- ggplot(costs_data, aes(x=Ownership, y=In_State_Tuition)) + 
  geom_boxplot() + 
  scale_y_continuous(trans="log10") + 
  geom_jitter() +
  labs(y ="In-State Tuition", title="In-State Tuition by Ownership Type for State Colleges") + 
  theme_minimal()
plot7

plot8 <- ggplot(costs_data, aes(x=Ownership, y=Out_State_Tuition)) + 
  geom_boxplot() + 
  scale_y_continuous(trans="log10") + 
  geom_jitter() +
  labs(y ="Out-of-State Tuition", title="Out-of-State Tuition by Ownership Type for State Colleges") + 
  theme_minimal()
plot8
```

```{r, warning=FALSE}
demographic_data <- demographic_info()
ggplot(demographic_data) +
  aes(x = ownership, y = count) +
  geom_col(fill = "#112446") +
  labs(
    x = "Ownership ",
    y = "Total Enrollment",
    title = "Undergraduate Students enrolled for each Ownership",
    subtitle = paste("State :", state, "; Locale :", locale)
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) 
```

```{r, warning=FALSE}
demographic_data_ownership <- demographic_data %>% 
  filter(!(ethnicity_gender %in% c("total_men", "total_women"))) %>% 
  group_by(ownership, ethnicity_gender) %>% 
  summarise(total_count = sum(count))
demographic_data_ownership

demographic_data_ownership %>% 
 filter(!(ethnicity_gender %in% "total_enrollment")) %>%
 ggplot() +
  aes(x = ownership, y = total_count, fill = ethnicity_gender) +
  geom_col(position = "dodge") +
  scale_fill_hue(direction = 1) +
  labs(
    x = "Ownership",
    y = "Total Student Count",
    title = "Undergraduate Students enrolled for each Ownership by Ethnicity",
    subtitle = paste("State :", state, "; Locale :", locale)
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) 
```

```{r, warning=FALSE}
demographic_data_gender <- demographic_data %>% 
  filter(ethnicity_gender %in% c("total_men", "total_women")) %>% 
  pivot_wider(names_from = ethnicity_gender, values_from = count)

men_plot <- ggplot(demographic_data_gender) +
  aes(x = ownership, y = total_men) +
  geom_boxplot(fill = "#112446") +
  geom_jitter() +
  scale_y_continuous(trans="log10") +
  labs(
    x = "Total Men",
    y = "Ownership",
    title = "Men Students for each Ownership",
    subtitle = paste("State :", state, "; Locale :", locale)
  ) +
  coord_flip() +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) 

women_plot <- ggplot(demographic_data_gender) +
  aes(x = ownership, y = total_women) +
  geom_boxplot(fill = "#112446") +
  geom_jitter() +
  scale_y_continuous(trans="log10") +
  labs(
    x = "Total Women",
    y = "Ownership",
    title = "Women Students for each Ownership",
    subtitle = paste("State :", state, "; Locale :", locale)
  ) +
  coord_flip() +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) 

grid.arrange(men_plot, women_plot, ncol=2)
```

```{r, warning=FALSE}
financial_data <- financial_info() %>% 
  group_by(ownership, city) %>% 
  summarise(median_poverty_rate = median(poverty_rate))
financial_data

financial_data %>%
 filter(!is.na(median_poverty_rate)) %>%
 ggplot() +
  aes(x = median_poverty_rate, y= ..density..) +
  geom_histogram(bins = 14L, fill = "#112446") +
  geom_density(color = "red", 
                 size = 2) +
  labs(
    x = "Poverty Rate",
    title = "Poverty Rate Distribution by State"
  ) +
  theme_minimal()

poverty_ownership <- financial_info() %>% 
  group_by(ownership) %>% 
  summarise(median_pr = mean(poverty_rate))

ggplot(poverty_ownership) +
  aes(x = ownership, y = median_pr) +
  geom_col(fill = "#112446") +
  labs(
    x = "Poverty Rate",
    title = "Poverty Rate by Ownership for Each State"
  ) +
  theme_minimal()
```

```{r, warning=FALSE}
earnings_data <- earnings_info()
instate_earning <- ggplot(earnings_data) +
  aes(x = In_State_Tuition, y = Median_Earnings) +
  geom_point(shape = "circle", size = 2, colour = "#112446") +
  geom_smooth(span = 0.75) +
  theme_minimal()

outstate_earning <-  ggplot(earnings_data) +
  aes(x = Out_State_Tuition, y = Median_Earnings) +
  geom_point(shape = "circle", size = 2, colour = "#112446") +
  geom_smooth(span = 0.75) +
  theme_minimal()

grid.arrange(instate_earning, outstate_earning, ncol=2)
```


<!-- ```{r, eval=FALSE} -->
<!-- admissions_info <- function(key="D3KHf387z9W0EaDoVZNsvD6aOSHPWZmwDvKpTxpr", ownership="public", rate="asc", n=50) -->
<!-- { -->
<!--   ownership <- ifelse(tolower(ownership)=="public", "1", -->
<!--                      ifelse(tolower(ownership)=="private", "2", -->
<!--                             ifelse(tolower(ownership)=="proprietary", "3", "ERROR"))) -->

<!--   url <- paste0("http://api.data.gov/ed/collegescorecard/v1/schools?api_key=D3KHf387z9W0EaDoVZNsvD6aOSHPWZmwDvKpTxpr", "&per_page=", n, "&school.degrees_awarded.predominant=3&school.ownership=", ownership, "&sort=admissions.admission_rate.overall:", rate) -->

<!--   data <- GET(url) -->

<!--   parsed_data <- fromJSON(rawToChar(data$content)) -->

<!--   school <- parsed_data$results$latest$school %>% -->
<!--      select(c("name", "state", "city", "ownership")) -->

<!--   school$ownership <- as.factor(school$ownership) -->
<!--         levels(school$ownership) <- c("Public", "Private, Nonprofit", "Proprietary") -->

<!--   admissions <- parsed_data$results$latest$admissions$admission_rate %>% -->
<!--     select("Admissions_Rate"=overall) -->

<!--   admissions2 <- parsed_data$results$latest$admissions %>% -->
<!--     select("Test_Requirements"=test_requirements) -->

<!--       admissions2$Test_Requirements <- as.factor(admissions2$Test_Requirements) -->
<!--         levels(admissions2$Test_Requirements) <- c("Required", "Recommended", "Neither required nor recommended", "Do not know", "Considered but not required") -->

<!--   admissions3 <- parsed_data$results$latest$admissions$sat_scores$midpoint %>% -->
<!--     select("SAT_Reading"=critical_reading, "SAT_Writing"=writing, "SAT_Math"=math) -->

<!--   admissions4 <- parsed_data$results$latest$admissions$act_scores$midpoint %>% -->
<!--     select("ACT_English"=english, "ACT_Writing"=writing, "ACT_Math"=math) -->

<!--   college_data <- -->
<!--     cbind(school, admissions, admissions2, admissions3, admissions4) %>% -->
<!--     as_tibble() -->

<!-- return(college_data) -->
<!-- } -->

<!-- admissions_info() -->
```
